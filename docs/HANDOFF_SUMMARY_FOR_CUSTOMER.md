# Краткая справка: статус работ и почему нужны доработки

## 1) Контекст

Проект автоматизирует обновление данных (кварталы/объекты) и синхронизацию этих данных в **ElevenLabs Knowledge Base** для использования агентом через **RAG**.

Часть работ уже выполнена, но для выхода в стабильный продакшен требуются финальные доработки и эксплуатационная настройка:
- **новая спецификация**, основанная на официальной документации ElevenLabs;
- **пошаговая инструкция** по настройке, тестированию и rollout (staging → production).

## 2) Почему нужны доработки (коротко)

Исторически в пайплайне были проблемы, из‑за которых RAG работал нестабильно или “казалось, что работает”, но данные не находились:
- **RAG индексация не гарантируется “сама собой”**: для документов нужно явно запускать/проверять индексацию через `/rag-index` и корректно обрабатывать статусы.
- **Ephemeral state на Render**: локальные файлы состояния не живут между запусками cron → без stateless подхода система начинает “обновлять всё” или, наоборот, пропускать изменения.
- **Дубликаты документов у агента** возможны при неправильной логике обновления массива `knowledge_base` (добавление вместо замены ID).
- Есть **edge-cases индексации** (например `rag_limit_exceeded`, `document_too_small`) — это не “баги кода”, а реальные ответы API, которые нужно учитывать в прод-логике и мониторинге.

Итог: чтобы система была production‑ready, нужны не только “функции”, но и **устойчивая эксплуатация** (env/cron/мониторинг/лимиты/rollback).

## 3) Что уже сделано в рамках передачи

- Подготовлена и уточнена спецификация:
  - `docs/ELEVENLABS_PIPELINE_SPEC.md`
- Подготовлена пошаговая инструкция выхода в продакшен (включая тесты и rollout):
  - `docs/PRODUCTION_HANDOFF_GUIDE.md`

Они дают заказчику и его разработчикам полную основу, чтобы:
- корректно настроить окружения,
- проверить работу индексации и обновления агента,
- безопасно включить cron на Render.

## 4) Что заказчику нужно доделать самостоятельно (чеклист)

### 4.1 Инфраструктура/окружения
- Развести **staging** и **production** (отдельные ElevenLabs агенты и отдельные Render окружения/переменные).
- Заполнить env‑переменные на Render (см. `PRODUCTION_HANDOFF_GUIDE.md`).
- Настроить cron (пока он выключен — это безопасно).

### 4.2 Тестирование перед включением cron
- Прогнать ручные сценарии:
  - dry‑run,
  - обновление 1–2 документов,
  - проверка статусов `rag-index`,
  - проверка, что агент реально “находит” данные через RAG.

### 4.3 Наблюдаемость и устойчивость
- Убедиться, что логи и метрики достаточно информативны (сколько обновлено, какие статусы, какие ошибки).
- Обработать лимиты/ошибки RAG (`rag_limit_exceeded`, `document_too_small`).
- Зафиксировать процедуру rollback (как быстро отключить cron и откатить knowledge_base агента).

## 5) Какие документы использовать как “источник правды”

- **Спецификация (как должно быть устроено)**: `docs/ELEVENLABS_PIPELINE_SPEC.md`
- **Инструкция (как это развернуть и проверить)**: `docs/PRODUCTION_HANDOFF_GUIDE.md`

## 6) Рекомендуемый порядок действий

1) Прочитать `PRODUCTION_HANDOFF_GUIDE.md` (разделы про env, ручные тесты, статусы индексации).
2) Поднять staging окружение и прогнать тесты.
3) Включить cron на staging на 24–48 часов.
4) После стабилизации — повторить для production.


