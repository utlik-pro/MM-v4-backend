# ElevenLabs Knowledge Base Pipeline - Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ

> **Ğ’ĞµÑ€ÑĞ¸Ñ:** 1.0  
> **Ğ”Ğ°Ñ‚Ğ°:** 2025-12-10  
> **Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** ĞŸÑ€Ğ¾ĞµĞºÑ‚ Ğ´Ğ»Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

---

ğŸ“‹ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸:
Ğ Ğ°Ğ·Ğ´ĞµĞ»	ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ
1. ĞĞ±Ğ·Ğ¾Ñ€ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹	Ğ¦ĞµĞ»ÑŒ, ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹, Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
2. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° API	KB, Agent, RAG, Ñ‚Ğ¸Ğ¿Ñ‹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
3. Ephemeral State	Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Render - stateless Ñ‡ĞµÑ€ĞµĞ· KB metadata
4. ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸	ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° + Ğ¿ÑĞµĞ²Ğ´Ğ¾ĞºĞ¾Ğ´
5. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²	ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğµ vs Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ
6. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº	Retry, Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ñ‹, rollback
7. ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³	ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸, Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ»Ğ¾Ğ³Ğ¾Ğ²
8. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ	ENV Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ, cron
9. ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ´Ğ°	ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ + Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ
10. Checklist	ĞŸĞ¾ÑˆĞ°Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

ğŸ”‘ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ñ‹:

ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° 1: UTF-8 ĞºĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²ĞºĞ°

âŒ POST /knowledge-base (multipart/form-data) â†’ type: file â†’ UTF-8 Ğ»Ğ¾Ğ¼Ğ°ĞµÑ‚ÑÑ
âœ… POST /knowledge-base/text (JSON) â†’ type: text â†’ UTF-8 Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚

ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° 2: Ephemeral state Ğ½Ğ° Render
âŒ Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ state Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğµ
âœ… Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒ size_bytes Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· API (stateless)

ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° 3: Ğ”ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹
âŒ new_kb = current_kb + updated_docs  (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ)
âœ… Ğ—Ğ°Ğ¼ĞµĞ½ÑÑ‚ÑŒ ID Ğ² ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°Ñ… (Ğ·Ğ°Ğ¼ĞµĞ½Ğ°)

ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° 4: Ğ˜Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ
âŒ Ğ–Ğ´Ğ°Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾ ElevenLabs ÑĞ°Ğ¼ Ğ¿Ñ€Ğ¾Ğ¸Ğ½Ğ´ĞµĞºÑĞ¸Ñ€ÑƒĞµÑ‚
âœ… Ğ¯Ğ²Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ POST /{id}/rag-index + Ğ¶Ğ´Ğ°Ñ‚ÑŒ succeeded


âš ï¸ ĞšĞ›Ğ®Ğ§Ğ•Ğ’Ğ«Ğ• ĞœĞĞœĞ•ĞĞ¢Ğ«
1 Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ /knowledge-base/text Ğ²Ğ¼ĞµÑÑ‚Ğ¾ /knowledge-base!
 - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° text (Ğ½Ğµ file)
 - UTF-8 ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾
2 RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ ĞĞ• Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ!
 - ĞŸĞ¾ÑĞ»Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ²Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ /rag-index
 - ĞÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒÑÑ status: succeeded
3 Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹!
 - Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ°Ğ³ĞµĞ½Ñ‚ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¸Ğ¼ĞµĞ» Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
 - ĞĞµÑ‚ "Ñ€Ğ°Ğ·Ñ€Ñ‹Ğ²Ğ°" ĞºĞ¾Ğ³Ğ´Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµÑ‚
4 Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ½ĞµĞ»ÑŒĞ·Ñ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ĞºĞ° Ğ¾Ğ½ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ğº Ğ°Ğ³ĞµĞ½Ñ‚Ñƒ!
 - Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° (ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ID)
 - ĞŸĞ¾Ñ‚Ğ¾Ğ¼ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚
 - Ğ˜Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ?force=true
5 State Ğ½Ğ° Render ephemeral!
 - ĞŸÑ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ cron Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ state Ñ‚ĞµÑ€ÑĞµÑ‚ÑÑ
 - ĞĞµ Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ state; Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹ â€” KB/Agent Ğ² ElevenLabs
 - ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑÑ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ stateless: ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒ `metadata.size_bytes` (Ğ¸ Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ Ñ…ĞµÑˆ Ñ‡ĞµÑ€ĞµĞ· `/content`)



## 1. ĞĞ±Ğ·Ğ¾Ñ€ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1.1 Ğ¦ĞµĞ»ÑŒ
ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ½ĞµĞ´Ğ²Ğ¸Ğ¶Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ bir.by Ğ² Knowledge Base ElevenLabs Ğ°Ğ³ĞµĞ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ AI-ĞºĞ¾Ğ½ÑÑƒĞ»ÑŒÑ‚Ğ°Ğ½Ñ‚Ğ°.

### 1.2 ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    bir.by       â”‚â”€â”€â”€â”€â–¶â”‚  Render Cron     â”‚â”€â”€â”€â”€â–¶â”‚  ElevenLabs API     â”‚
â”‚  (Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº)     â”‚     â”‚  (Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°)     â”‚     â”‚  (KB + Agent)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ
- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (Ğ½Ğµ Ğ²ÑĞµÑ…)
- ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° UTF-8 (ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ°)
- ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ² Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
- ĞĞµĞ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ°Ğ³ĞµĞ½Ñ‚Ğ° (Ğ±ĞµĞ· "Ñ€Ğ°Ğ·Ñ€Ñ‹Ğ²Ğ¾Ğ²" Ğ² Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
- ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ°

---

## 2. ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ElevenLabs API

### 2.1 Knowledge Base (KB)
Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ², **Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾Ğµ Ğ¾Ñ‚ Ğ°Ğ³ĞµĞ½Ñ‚Ğ¾Ğ²**.

#### Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²:

| Ğ¢Ğ¸Ğ¿ | Endpoint | Content-Type | UTF-8 | Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ |
|-----|----------|--------------|-------|---------------|
| `text` | `POST /knowledge-base/text` | `application/json` | âœ… | **Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ** |
| `file` | `POST /knowledge-base` | `multipart/form-data` | âŒ | ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ |
| `url` | `POST /knowledge-base/url` | `application/json` | â€” | Ğ”Ğ»Ñ Ğ²ĞµĞ±-ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ† |

#### Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ TEXT Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°:
```http
POST /v1/convai/knowledge-base/text
Content-Type: application/json
xi-api-key: {API_KEY}

{
    "text": "# Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°...",
    "name": "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°"
}

Response:
{
    "id": "abc123xyz",
    "name": "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°"
}
```

### 2.2 Agent Knowledge Base
Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ², Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğº Ğ°Ğ³ĞµĞ½Ñ‚Ñƒ.

**ĞŸÑƒÑ‚ÑŒ Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°:**
```
conversation_config.agent.prompt.knowledge_base[]
```

#### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° KnowledgeBaseLocator:
```json
{
    "type": "text",           // "text" | "file" | "url"
    "name": "18-Chempionov",  // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼Ğ¾Ğµ Ğ¸Ğ¼Ñ
    "id": "abc123xyz",        // ID Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ğ² KB
    "usage_mode": "auto"      // "prompt" | "auto"
}
```

#### Usage Mode:

| Ğ ĞµĞ¶Ğ¸Ğ¼ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ |
|-------|----------|-------------------|
| `prompt` | Ğ’ÑĞµĞ³Ğ´Ğ° Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ LLM | ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ (ĞœĞ‘Ğ, Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°) |
| `auto` | Ğ§ĞµÑ€ĞµĞ· RAG Ğ¿Ğ¾Ğ¸ÑĞº | Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (ĞºĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»Ñ‹) |

### 2.3 RAG Ğ˜Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ

**Ğ’ĞĞ–ĞĞ:** RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ ĞĞ• Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°!

#### Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸:
```http
POST /v1/convai/knowledge-base/{doc_id}/rag-index
Content-Type: application/json
xi-api-key: {API_KEY}

{
    "model": "multilingual_e5_large_instruct"
}
```

**Ğ’Ğ°Ğ¶Ğ½Ğ¾ (Ğ¿Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸):** `POST /rag-index` **Ğ¸Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚ĞµĞ½** â€” ĞµÑĞ»Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑƒĞ¶Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½, endpoint Ğ²ĞµÑ€Ğ½Ñ‘Ñ‚ **Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ**, Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ñ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½ÑƒÑ Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ.

#### ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°:
```http
GET /v1/convai/knowledge-base/{doc_id}/rag-index
xi-api-key: {API_KEY}

Response:
{
    "indexes": [{
        "id": "index_id",
        "model": "multilingual_e5_large_instruct",
        "status": "succeeded",        // created | processing | succeeded | failed | rag_limit_exceeded | document_too_small
        "progress_percentage": 100.0
    }]
}
```

**Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²:**
- `succeeded`: OK, Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ `usage_mode: auto`
- `processing/created`: Ğ¶Ğ´Ñ‘Ğ¼ (polling Ñ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ¼)
- `failed`: Ğ¾ÑˆĞ¸Ğ±ĞºĞ° â€” retry/Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°
- `rag_limit_exceeded`: Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½ RAG Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ (ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ KB size/Ğ¾Ğ±ÑŠÑ‘Ğ¼Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²)
- `document_too_small`: Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ°Ğ» Ğ´Ğ»Ñ Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸ (Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ÑŒ/Ğ¿ĞµÑ€ĞµĞ²ĞµÑÑ‚Ğ¸ Ğ² `prompt` Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)

**ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğ¹ endpoint Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ñ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ² KB/RAG:**
```http
GET /v1/convai/agent/{agent_id}/knowledge-base/size
xi-api-key: {API_KEY}
```

### 2.4 ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Agent
```http
PATCH /v1/convai/agents/{agent_id}
Content-Type: application/json
xi-api-key: {API_KEY}

{
    "conversation_config": {
        "agent": {
            "prompt": {
                "knowledge_base": [
                    { "type": "text", "name": "ĞœĞ‘Ğ", "id": "old_id", "usage_mode": "prompt" },
                    { "type": "text", "name": "18-Chempionov", "id": "NEW_id", "usage_mode": "auto" }
                ]
            }
        }
    }
}
```

### 2.5 Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°
```http
DELETE /v1/convai/knowledge-base/{doc_id}
xi-api-key: {API_KEY}

# Ğ¡ Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸ĞµĞ¼ (Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ğº Ğ°Ğ³ĞµĞ½Ñ‚Ğ°Ğ¼):
DELETE /v1/convai/knowledge-base/{doc_id}?force=true
```

Ğ¢Ğ°ĞºĞ¶Ğµ Ğ¿Ğ¾Ğ»ĞµĞ·Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸:
```http
GET /v1/convai/knowledge-base/{doc_id}/dependent-agents
xi-api-key: {API_KEY}
```

---

## 3. Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ephemeral State Ğ½Ğ° Render

### 3.1 ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°
Render Cron Jobs Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ ephemeral (Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¹) Ğ´Ğ¸ÑĞº. Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ñ‚ĞµÑ€ÑÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°.

### 3.2 Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Stateless Architecture

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:** ĞĞµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ state Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° ĞºĞ°Ğº "Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ¿Ñ€Ğ°Ğ²Ğ´Ñ‹".

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATELESS ĞŸĞĞ”Ğ¥ĞĞ”                         â”‚
â”‚                                                             â”‚
â”‚  ĞŸÑ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ cron:                                   â”‚
â”‚  1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°                       â”‚
â”‚  2. Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ `local_size_bytes` (UTF-8) Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… MD      â”‚
â”‚  3. Ğ‘ĞµÑ€Ñ‘Ğ¼ `metadata.size_bytes` Ğ¸Ğ· KB Ğ¿Ğ¾ doc_id              â”‚
â”‚  4. ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ²ÑˆĞ¸ĞµÑÑ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ (Ğ±ĞµĞ· Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ state):

```python
def get_documents_to_update():
    # 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
    agent_docs = get_agent_kb()  # {name: {id, type, usage_mode}}
    
    # 2. Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ MD Ñ„Ğ°Ğ¹Ğ»Ğ°
    for md_file in quarters/*.md:
        name = md_file.stem
        local_hash = MD5(md_file.content)
        
        # 3. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· KB
        if name in agent_docs:
            doc_id = agent_docs[name]['id']
            kb_content = get_kb_document_content(doc_id)
            kb_hash = MD5(kb_content)
            
            # 4. Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ…ĞµÑˆĞ¸
            if local_hash != kb_hash:
                files_to_update.append(name)
        else:
            # ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚
            files_to_update.append(name)
    
    return files_to_update
```

#### ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ğ¸Ğ· KB:

**Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 1: Ğ§ĞµÑ€ĞµĞ· /content (streaming)**
```http
GET /v1/convai/knowledge-base/{doc_id}/content
xi-api-key: {API_KEY}

Response: Streaming document content (raw text)
```

**Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 2: Ğ§ĞµÑ€ĞµĞ· GET document (JSON Ñ extracted_inner_html)**
```http
GET /v1/convai/knowledge-base/{doc_id}
xi-api-key: {API_KEY}

Response:
{
    "id": "doc_id",
    "name": "18-Chempionov",
    "type": "text",
    "extracted_inner_html": "# Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°...",
    "metadata": {
        "size_bytes": 12345,
        "created_at_unix_secs": 1733850000
    }
}
```

**Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ:** Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `/content` Ğ´Ğ»Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (streaming), `GET /{id}` Ğ´Ğ»Ñ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….

### 3.3 ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ size_bytes

Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²ÑĞµĞ³Ğ¾ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğ³Ğ¾ Ğ´Ğ»Ñ Ñ…ĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `size_bytes` Ğ¸Ğ· metadata:

```python
def get_documents_to_update_optimized():
    """ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñƒ Ñ„Ğ°Ğ¹Ğ»Ğ°"""
    
    agent_docs = get_agent_kb()  # {name: {id, type}}
    
    for md_file in quarters/*.md:
        name = md_file.stem
        local_size = len(md_file.content.encode('utf-8'))
        
        if name in agent_docs:
            doc_id = agent_docs[name]['id']
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ metadata (Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾!)
            doc_info = get_kb_document_info(doc_id)
            kb_size = doc_info['metadata']['size_bytes']
            
            if local_size != kb_size:
                files_to_update.append(name)
        else:
            files_to_update.append(name)
    
    return files_to_update
```

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- ĞĞµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°
- Ğ‘Ñ‹ÑÑ‚Ñ€ĞµĞµ Ğ² 10-100 Ñ€Ğ°Ğ·
- Ğ”Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

**ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ:** ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ, Ğ½Ğ¾ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ ÑĞ¾Ğ²Ğ¿Ğ°Ğ» â€” ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ `size_bytes` Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ.  
Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ â€” Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ `strict mode`: Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğµ Ğ´Ğ¾ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ `/content` Ğ¸ ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ…ĞµÑˆ.

### 3.4 ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶ĞµĞ½ persistent state)

| Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ | Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ | Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ | Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ |
|---------|-----------|-----------|--------------|
| Stateless (Ñ‡ĞµÑ€ĞµĞ· KB metadata) | $0 | ĞĞ¸Ğ·ĞºĞ°Ñ | âœ… **Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ** |
| Render Disk | $0.25/GB/Ğ¼ĞµÑ | ĞĞ¸Ğ·ĞºĞ°Ñ | Ğ”Ğ»Ñ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… |
| Render PostgreSQL | $7+/Ğ¼ĞµÑ | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | Ğ•ÑĞ»Ğ¸ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ Ğ‘Ğ” |
| Render Key-Value | $0 (free tier) | ĞĞ¸Ğ·ĞºĞ°Ñ | Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ KV |
| External S3 | ~$0.02/GB | Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ | Ğ”Ğ»Ñ Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ² |
| Git (state file Ğ² Ñ€ĞµĞ¿Ğ¾) | $0 | ĞĞ¸Ğ·ĞºĞ°Ñ | âš ï¸ ĞĞµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ |

### 3.5 Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ Ñ Render Key-Value (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶ĞµĞ½ state)

Ğ•ÑĞ»Ğ¸ stateless Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚, Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Render Key-Value:

```python
import redis

# ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Render Key-Value
kv = redis.from_url(os.environ['REDIS_URL'])

def save_state(quarters_state: dict):
    """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ state Ğ² Key-Value"""
    kv.set('quarters_state', json.dumps(quarters_state))

def load_state() -> dict:
    """Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ state Ğ¸Ğ· Key-Value"""
    data = kv.get('quarters_state')
    return json.loads(data) if data else {}

def update_quarter_state(name: str, doc_id: str, content_hash: str):
    """ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ state Ğ´Ğ»Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»Ğ°"""
    state = load_state()
    state[name] = {
        'doc_id': doc_id,
        'content_hash': content_hash,
        'updated_at': datetime.now().isoformat()
    }
    save_state(state)
```

---

## 4. ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹)

### 4.1 Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CRON JOB (ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 1: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ bir.by                                    â”‚
â”‚ GET https://bir.by/ai/json_ai.php                                   â”‚
â”‚ â†’ ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ JSON                                                      â”‚
â”‚ â†’ Ğ Ğ°Ğ·Ğ±Ğ¸Ğ²ĞºĞ° Ğ¿Ğ¾ ĞºĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»Ğ°Ğ¼                                             â”‚
â”‚ â†’ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ MD ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ°                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 2: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°                          â”‚
â”‚ GET /v1/convai/agents/{agent_id}                                    â”‚
â”‚ â†’ conversation_config.agent.prompt.knowledge_base[]                 â”‚
â”‚ â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ map: { name â†’ {id, type, usage_mode} }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 3: ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹                                        â”‚
â”‚ Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ MD Ñ„Ğ°Ğ¹Ğ»Ğ°:                                               â”‚
â”‚   local_hash = MD5(md_content)                                      â”‚
â”‚   kb_content = GET /knowledge-base/{id}/content                     â”‚
â”‚   kb_hash = MD5(kb_content)                                         â”‚
â”‚   if local_hash != kb_hash â†’ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² update_list                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Ğ•ÑÑ‚ÑŒ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ?     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚              â”‚
                          ĞĞ•Ğ¢            Ğ”Ğ
                           â”‚              â”‚
                           â–¼              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   EXIT   â”‚   â”‚ Ğ¨ĞĞ“ 4: Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ Ğº Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ:                   â”‚
                                   â”‚                                 â”‚
                                   â”‚ 4.1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚     â”‚
                                   â”‚      POST /knowledge-base/text  â”‚
                                   â”‚      â†’ new_doc_id               â”‚
                                   â”‚                                 â”‚
                                   â”‚ 4.2. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ   â”‚
                                   â”‚      POST /{id}/rag-index       â”‚
                                   â”‚                                 â”‚
                                   â”‚ 4.3. ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸        â”‚
                                   â”‚      GET /{id}/rag-index        â”‚
                                   â”‚      â†’ status == "succeeded"    â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 5: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°                                            â”‚
â”‚ PATCH /v1/convai/agents/{agent_id}                                  â”‚
â”‚ â†’ Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ID Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ² knowledge_base[]                    â”‚
â”‚ â†’ ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ (prompt) - Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹                     â”‚
â”‚ â†’ ĞĞ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ñ‹Ğµ ĞºĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»Ñ‹ (auto) - Ğ½Ğ¾Ğ²Ñ‹Ğµ ID                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 6: Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²                                   â”‚
â”‚ DELETE /v1/convai/knowledge-base/{old_doc_id}                       â”‚
â”‚ (Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ğ²ÑĞ·Ğ°Ğ½Ñ‹ Ğ¾Ñ‚ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° Ğ½Ğ° ÑˆĞ°Ğ³Ğµ 5)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ğ¨ĞĞ“ 7: Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²                                      â”‚
â”‚ â†’ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²                                 â”‚
â”‚ â†’ Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ                                                  â”‚
â”‚ â†’ ĞÑˆĞ¸Ğ±ĞºĞ¸ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ĞŸÑĞµĞ²Ğ´Ğ¾ĞºĞ¾Ğ´

```python
def sync_pipeline():
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸"""
    
    log("ğŸš€ ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸")
    
    # Ğ¨ĞĞ“ 1: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ bir.by
    raw_data = fetch_birby_data()
    quarters_data = split_by_quarters(raw_data)
    md_files = generate_md_files(quarters_data)
    
    # Ğ¨ĞĞ“ 2: ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
    agent_kb = get_agent_kb()  # {name: {id, type, usage_mode}}
    
    # Ğ¨ĞĞ“ 3: ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
    files_to_update = []
    for md_file in md_files:
        name = md_file.stem
        local_hash = calculate_hash(md_file.content)
        
        if name in agent_kb:
            # Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ»Ğ¸
            doc_id = agent_kb[name]['id']
            kb_content = get_kb_document_content(doc_id)
            kb_hash = calculate_hash(kb_content)
            
            if local_hash != kb_hash:
                files_to_update.append({
                    'name': name,
                    'content': md_file.content,
                    'old_doc_id': doc_id
                })
        else:
            # ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚
            files_to_update.append({
                'name': name,
                'content': md_file.content,
                'old_doc_id': None
            })
    
    if not files_to_update:
        log("âœ… Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ½ĞµÑ‚")
        return
    
    log(f"ğŸ“ Ğš Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: {len(files_to_update)} Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²")
    
    # Ğ¨ĞĞ“ 4: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    updated_docs = []
    old_doc_ids = []
    
    for file_info in files_to_update:
        # 4.1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚
        new_doc_id = create_text_document(
            text=file_info['content'],
            name=file_info['name']
        )
        
        # 4.2. Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ
        trigger_rag_indexing(new_doc_id)
        
        # 4.3. Ğ”Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒÑÑ Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸
        wait_for_indexing(new_doc_id, timeout=60)
        
        updated_docs.append({
            'name': file_info['name'],
            'new_id': new_doc_id
        })
        
        if file_info['old_doc_id']:
            old_doc_ids.append(file_info['old_doc_id'])
    
    # Ğ¨ĞĞ“ 5: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
    new_kb = build_new_kb(agent_kb, updated_docs)
    update_agent_kb(new_kb)
    
    # Ğ¨ĞĞ“ 6: Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
    for old_id in old_doc_ids:
        delete_document(old_id)
    
    log(f"âœ… Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°: {len(updated_docs)} Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²")
```

---

## 5. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²

### 5.1 ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ (usage_mode: prompt)

| Ğ˜Ğ¼Ñ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ |
|-----|----------|------------|
| ĞœĞ‘Ğ | Ğ‘Ğ¸Ğ·Ğ½ĞµÑ-Ğ°Ğ¿Ğ°Ñ€Ñ‚Ğ°Ğ¼ĞµĞ½Ñ‚Ñ‹ | Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ |
| 00-obschie-svedeniya | ĞĞ±Ñ‰Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ | Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ |
| 01-obrazovatelnaya-infrastruktura | ĞĞ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ |
| 02-parkinki-i-sport | ĞŸĞ°Ñ€ĞºĞ¸Ğ½Ğ³Ğ¸ Ğ¸ ÑĞ¿Ğ¾Ñ€Ñ‚ | Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ |
| 03-finansovye-uslugi | Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹ | Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ |
| 03-empathy-enhancer | Ğ­Ğ¼Ğ¿Ğ°Ñ‚Ğ¸Ñ | Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ |
| 05-sroki-sdachi-domov | Ğ¡Ñ€Ğ¾ĞºĞ¸ ÑĞ´Ğ°Ñ‡Ğ¸ | Ğ ÑƒÑ‡Ğ½Ğ¾Ğµ |

### 5.2 Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ (usage_mode: auto)

| ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ Ğ¸Ğ¼ĞµĞ½Ğ¸ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ |
|---------------|----------|------------|
| `{N}-{QuarterName}` | Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ĞºĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»Ğ° | ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ (cron) |

ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: `18-Chempionov`, `21-Zapadnyy`, `27-Happy-Planet`

### 5.3 Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ MD Ñ„Ğ°Ğ¹Ğ»Ğ° ĞºĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»Ğ°

```markdown
# ğŸ˜ï¸ ĞšĞ²Ğ°Ñ€Ñ‚Ğ°Ğ» â€” {ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ}

## ğŸ“ ĞĞ±Ñ‰Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
**ĞšĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»:** {ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ}
**Ğ“Ğ¾Ñ€Ğ¾Ğ´:** ĞœĞ¸Ğ½ÑĞº
**Ğ Ğ°Ğ¹Ğ¾Ğ½:** ĞœĞ¸Ñ€
**ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²:** {N}

## ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°
**Ğ”Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´ĞµĞ¹:** {min} - {max} Ğ¼Â²
**Ğ¡Ñ€ĞµĞ´Ğ½ÑÑ Ñ†ĞµĞ½Ğ° Ğ·Ğ° Ğ¼Â²:** {avg} ĞµĞ²Ñ€Ğ¾
**ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:** {min} - {max} ĞµĞ²Ñ€Ğ¾

## ğŸ  Ğ”Ğ¾Ğ¼ {Ğ½Ğ¾Ğ¼ĞµÑ€}
**ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾Ğ¼Ğ°:** {Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ}
...

### ğŸ  ĞšĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ° {Ğ½Ğ¾Ğ¼ĞµÑ€}
**ĞŸĞ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ:** {X} Ğ¼Â²
**Ğ¦ĞµĞ½Ğ° Ğ·Ğ° Ğ¼Â²:** {Y} ĞµĞ²Ñ€Ğ¾
**ĞĞ±Ñ‰Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ:** {Z} ĞµĞ²Ñ€Ğ¾
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** {ÑÑ‚Ğ°Ñ‚ÑƒÑ}
...
```

---

## 6. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

### 6.1 Retry Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

```python
MAX_RETRIES = 3
RETRY_DELAY = 5  # ÑĞµĞºÑƒĞ½Ğ´

def api_call_with_retry(func, *args, **kwargs):
    for attempt in range(MAX_RETRIES):
        try:
            return func(*args, **kwargs)
        except (Timeout, ConnectionError) as e:
            if attempt < MAX_RETRIES - 1:
                time.sleep(RETRY_DELAY * (attempt + 1))
            else:
                raise
```

### 6.2 Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ñ‹

| ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ | Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ |
|----------|---------|
| ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… bir.by | 30 ÑĞµĞº |
| Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° | 60 ÑĞµĞº |
| RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ | 120 ÑĞµĞº |
| ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° | 300 ÑĞµĞº |
| Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° | 30 ÑĞµĞº |

### 6.3 Rollback Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ñ…

```python
def sync_with_rollback():
    created_docs = []
    
    try:
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
        for file in files_to_update:
            doc_id = create_document(file)
            created_docs.append(doc_id)
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
        update_agent(...)
        
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ
        delete_old_documents(...)
        
    except Exception as e:
        # ROLLBACK: ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
        for doc_id in created_docs:
            try:
                delete_document(doc_id, force=True)
            except:
                pass
        raise
```

---

## 7. ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¸ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### 7.1 ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ

- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² Ğ°Ğ³ĞµĞ½Ñ‚Ğµ
- ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ·Ğ° Ñ†Ğ¸ĞºĞ»
- Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸
- ĞÑˆĞ¸Ğ±ĞºĞ¸ API

### 7.2 Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ»Ğ¾Ğ³Ğ¾Ğ²

```
[2025-12-10 14:00:00] ğŸš€ ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
[2025-12-10 14:00:05] ğŸ“¥ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾ 18 ĞºĞ²Ğ°Ñ€Ñ‚Ğ°Ğ»Ğ¾Ğ² Ñ bir.by
[2025-12-10 14:00:10] ğŸ“Š Ğš Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ: 2 Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°
[2025-12-10 14:00:15]    ğŸ“¤ 18-Chempionov â†’ abc123
[2025-12-10 14:00:20]    âœ… RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ: succeeded
[2025-12-10 14:00:25]    ğŸ“¤ 21-Zapadnyy â†’ def456
[2025-12-10 14:00:30]    âœ… RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ: succeeded
[2025-12-10 14:00:35] ğŸ¤– ĞĞ³ĞµĞ½Ñ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½ (25 Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²)
[2025-12-10 14:00:40] ğŸ—‘ï¸  Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‹Ñ…: 2
[2025-12-10 14:00:40] âœ… Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° Ğ·Ğ° 40 ÑĞµĞº
```

---

## 8. ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ

### 8.1 ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

```bash
# ElevenLabs API
ELEVENLABS_API_KEY=sk_xxxxx
ELEVENLABS_AGENT_ID=agent_xxxxx

# Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
BIRBY_API_URL=https://bir.by/ai/json_ai.php

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
RAG_EMBEDDING_MODEL=multilingual_e5_large_instruct
RAG_INDEXING_TIMEOUT=120
SYNC_MAX_RETRIES=3
```

### 8.2 Render Cron Schedule

```
# ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‡Ğ°Ñ Ğ² 0 Ğ¼Ğ¸Ğ½ÑƒÑ‚
0 * * * *

# ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°
python3 sync-with-monitoring.py --check --upload-to-elevenlabs
```

---

## 9. ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ´Ğ° vs Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ

### 9.1 ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

| ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° | ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° | Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ |
|----------|---------|---------|
| **Ğ”ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹ (5 Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²)** | ĞŸÑ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° Ğ½Ğµ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ ID | Ğ—Ğ°Ğ¼ĞµĞ½ÑÑ‚ÑŒ ID Ğ² Ğ¼Ğ°ÑÑĞ¸Ğ²Ğµ, Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ |
| **Ğ’ÑĞµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑÑÑ‚ÑÑ** | Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ state Ñ‚ĞµÑ€ÑĞµÑ‚ÑÑ Ğ½Ğ° ephemeral Ğ´Ğ¸ÑĞºĞµ | Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ stateless Ñ‡ĞµÑ€ĞµĞ· KB metadata |
| **ĞšĞ¾Ğ´Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° UTF-8 Ğ»Ğ¾Ğ¼Ğ°ĞµÑ‚ÑÑ** | Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ `/knowledge-base` (file) | Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `/knowledge-base/text` (text) |
| **Ğ˜Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚** | RAG index Ğ½Ğµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ ÑĞ²Ğ½Ğ¾ | Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ POST /{id}/rag-index |

### 9.2 Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ĞºĞ¾Ğ´ (elevenlabs_sync_v2.py)

```python
# ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ 1: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ file upload Ğ²Ğ¼ĞµÑÑ‚Ğ¾ text
def upload_document(file_path: str, name: str):
    files = {
        'file': (f'{name}.html', content_bytes, 'text/html')  # âŒ type: file
    }
    data = {'name': name}
    resp = requests.post(f"{BASE_URL}/convai/knowledge-base", ...)  # âŒ file endpoint
```

```python
# ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ 2: State Ñ‚ĞµÑ€ÑĞµÑ‚ÑÑ
quarters_state = load_quarters_state()  # âŒ Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
if not quarters_state:
    quarters_state = initialize_from_agent()  # Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ
```

```python
# ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ 3: Ğ”ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
new_kb = current_kb + updated_docs  # âŒ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµÑ‚, Ğ½Ğµ Ğ·Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚
```

### 9.3 ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```python
# Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ• 1: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ text endpoint
def upload_document(content: str, name: str):
    payload = {
        "text": content,
        "name": name
    }
    resp = requests.post(
        f"{BASE_URL}/convai/knowledge-base/text",  # âœ… text endpoint
        headers=headers,
        json=payload  # âœ… JSON, Ğ½Ğµ multipart
    )
    return resp.json()['id']
```

```python
# Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ• 2: Stateless Ñ‡ĞµÑ€ĞµĞ· KB metadata
def get_files_to_update():
    agent_docs = get_agent_kb()  # {name: {id, size}}
    
    for md_file in md_files:
        local_size = len(md_file.content.encode('utf-8'))
        
        if md_file.name in agent_docs:
            doc_info = get_document_info(agent_docs[md_file.name]['id'])
            kb_size = doc_info['metadata']['size_bytes']
            
            if local_size != kb_size:  # âœ… Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñƒ
                files_to_update.append(md_file)
        else:
            files_to_update.append(md_file)
    
    return files_to_update
```

```python
# Ğ Ğ•Ğ¨Ğ•ĞĞ˜Ğ• 3: Ğ—Ğ°Ğ¼ĞµĞ½Ğ°, Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
def build_new_kb(current_kb, updated_docs):
    new_kb = []
    updated_names = {d['name']: d['new_id'] for d in updated_docs}
    
    for doc in current_kb:
        if doc['name'] in updated_names:
            # Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ ID Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğ¹
            new_kb.append({
                **doc,
                'id': updated_names[doc['name']]  # âœ… ĞĞ¾Ğ²Ñ‹Ğ¹ ID
            })
        else:
            # ĞÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ
            new_kb.append(doc)
    
    return new_kb  # âœ… Ğ‘ĞµĞ· Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²
```

---

## 10. Checklist Ğ´Ğ»Ñ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### Ğ­Ñ‚Ğ°Ğ¿ 1: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ upload
- [ ] Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ `POST /knowledge-base` Ğ½Ğ° `POST /knowledge-base/text`
- [ ] Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ HTML wrapper (Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ´Ğ»Ñ text endpoint)
- [ ] ĞŸĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ Ñ‡ĞµÑ€ĞµĞ· JSON body

### Ğ­Ñ‚Ğ°Ğ¿ 2: Stateless Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
- [ ] ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ÑŒ metadata Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· `GET /knowledge-base/{id}`
- [ ] Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒ `size_bytes` Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ñ…ĞµÑˆĞµĞ¹
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ strict-mode: Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ²Ğ½Ğ¾Ğ¼ `size_bytes` ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ `GET /knowledge-base/{id}/content`
- [ ] Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ state Ñ„Ğ°Ğ¹Ğ»Ğ°

### Ğ­Ñ‚Ğ°Ğ¿ 3: RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ²Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ·Ğ¾Ğ² `POST /{id}/rag-index`
- [ ] Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ `status: succeeded` (Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ `failed/rag_limit_exceeded/document_too_small`)
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ timeout Ğ´Ğ»Ñ Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ğ¸

### Ğ­Ñ‚Ğ°Ğ¿ 4: ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° Ğ±ĞµĞ· Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²
- [ ] Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼Ğ°ÑÑĞ¸Ğ² knowledge_base Ğ·Ğ°Ğ¼ĞµĞ½Ğ¾Ğ¹ ID
- [ ] ĞĞµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ ĞµÑĞ»Ğ¸ Ğ¸Ğ¼Ñ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ
- [ ] Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ´ PATCH

### Ğ­Ñ‚Ğ°Ğ¿ 5: Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
- [ ] Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ old_doc_id Ğ¿ĞµÑ€ĞµĞ´ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¾Ğ¹
- [ ] Ğ£Ğ´Ğ°Ğ»ÑÑ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
- [ ] ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ "document_has_dependent_agents"
- [ ] ĞŸÑ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `GET /knowledge-base/{id}/dependent-agents` Ğ¸ fallback `DELETE ...?force=true`

### Ğ­Ñ‚Ğ°Ğ¿ 6: Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- [ ] ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ text Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ñ ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†ĞµĞ¹
- [ ] ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ RAG Ğ¸Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ
- [ ] ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ğ°
- [ ] ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» cron

---

## 10. Ğ¡ÑÑ‹Ğ»ĞºĞ¸

- [ElevenLabs API Reference](https://elevenlabs.io/docs/api-reference)
- [Knowledge Base API](https://elevenlabs.io/docs/api-reference/knowledge-base)
- [Agents API](https://elevenlabs.io/docs/api-reference/agents)
- [Render Cron Jobs](https://render.com/docs/cronjobs)

