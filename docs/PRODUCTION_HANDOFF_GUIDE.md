# Production Handoff Guide (Customer) — ElevenLabs KB/RAG Pipeline

Документ для заказчика: как **настроить**, **протестировать** и **ввести в продакшен** пайплайн обновления Knowledge Base (KB) и RAG-индексации ElevenLabs агента, используя **Claude Code IDE** или **Cursor IDE**.

## 1) Что именно деплоим

Пайплайн делает следующее:
- Генерирует/обновляет локальные markdown документы (кварталы) в `quarters/…` (это делает `sync-with-monitoring.py`).
- Загружает изменённые документы в ElevenLabs KB **как text-документы** (`POST /v1/convai/knowledge-base/text`).
- Запускает/проверяет RAG-индексацию (`POST/GET /v1/convai/knowledge-base/{id}/rag-index`).
- Обновляет агента через **правильный путь**:
  - `conversation_config.agent.prompt.knowledge_base[]`
- Удаляет старые документы после успешного обновления агента (с fallback `?force=true` при необходимости).

Источник правды для stateless-логики: **текущая конфигурация агента и документы в ElevenLabs KB**, а не локальный state на Render (ephemeral).

## 2) Что передавать: PR/commit или архив

Рекомендация:
- **Основной канал**: PR/commit в git заказчика (прозрачный diff, ревью, история, откат).
- **Архив**: только как резервный “снэпшот” (если нет доступа к репозиторию/нужен офлайн аудит).

Если cron на Render выключен, коммит **не повлияет на работу** до включения деплоя/cron самим заказчиком.

## 3) Минимальные требования к окружению

### 3.1 Переменные окружения (Render / локально)

Обязательные:
- `ELEVENLABS_API_KEY`
- `ELEVENLABS_AGENT_ID`

Рекомендуемые:
- `RAG_EMBEDDING_MODEL` (по умолчанию: `multilingual_e5_large_instruct`)
- `RAG_INDEXING_TIMEOUT` (секунды, например `120` или `180`)
- `BIRBY_API_URL` (если используется в мониторинге; пример: `https://bir.by/ai/json_ai.php`)

### 3.2 Разделение окружений (обязательно для безопасного запуска)

Сделайте два окружения:
- **staging**: тестовый агент ElevenLabs + тестовый Render Cron (или ручные запуски)
- **production**: боевой агент + боевой cron

Важно: staging агент должен быть **отдельным** от production, иначе тесты “портят” боевую KB.

## 4) Как работать через Cursor IDE / Claude Code IDE

### 4.1 Рекомендованный подход (AI помогает, вы подтверждаете)

1) Откройте репозиторий в Cursor/Claude Code IDE.
2) Попросите ассистента:
   - **проверить** `render.yaml`/Render settings,
   - **проверить** что команды запуска/cron соответствуют документации,
   - **подготовить** список env vars для Render,
   - **сформировать** plan для staging → production.
3) Выполняйте шаги ниже и фиксируйте изменения в PR.

### 4.2 Примеры “промптов” для IDE

- **Render настройки**:  
  “Проверь `render.yaml` и текущие команды cron. Скажи, как безопасно включить staging cron и какие env vars нужны.”

- **Проверка пайплайна**:  
  “Собери чеклист тестов для `sync-with-monitoring.py` + `elevenlabs_sync_v2.py` и укажи ожидаемые логи успеха/ошибок.”

- **Разбор ошибок индексации**:  
  “Если `rag-index` возвращает `rag_limit_exceeded` или `document_too_small`, предложи решения и что менять в данных/документах.”

## 5) Тестирование (до включения cron)

### 5.1 Smoke-test (без изменений)

На локальной машине или в временном окружении Render (one-off job):

```bash
python3 elevenlabs_sync_v2.py --dir quarters --dry-run
```

Ожидаем:
- env переменные читаются,
- агент доступен,
- скрипт пишет, какие документы потенциально обновит,
- **ничего не загружает** (dry-run).

### 5.2 Тест обновления 1–2 документов (staging агент)

1) Возьмите 1 документ в `quarters/*.md` и внесите маленькое изменение (1 строка).
2) Запустите:

```bash
python3 elevenlabs_sync_v2.py --dir quarters --index-wait 180
```

Ожидаем:
- создан новый KB doc через `/knowledge-base/text`
- выполнен `POST /rag-index`
- дождались `status: succeeded` (или получили понятный статус/ошибку)
- выполнен `PATCH` агента по `conversation_config.agent.prompt.knowledge_base`
- удалены старые версии (или зафиксировано, почему не удалились)

### 5.3 “Strict” проверка рассинхронизаций (опционально)

Если есть риск кейса “контент изменился, но размер тот же”:

```bash
python3 elevenlabs_sync_v2.py --dir quarters --strict-hash --index-wait 180
```

`--strict-hash` сравнивает содержимое через `GET /knowledge-base/{id}/content` при равных `size_bytes`.

## 6) Проверка, что RAG реально работает

После прогона (staging):
- В ElevenLabs UI/консоли убедитесь, что у агента обновился список `knowledge_base` (новые `id`).
- Проверьте статус индексации документа:
  - `GET /v1/convai/knowledge-base/{doc_id}/rag-index`
  - ожидаемый `status: succeeded`

### 6.1 Частые статусы и что делать

- **`succeeded`**: OK.
- **`processing/created`**: подождать, polling до таймаута.
- **`failed`**: retry, смотреть тело ответа/логи, убедиться, что документ валиден.
- **`rag_limit_exceeded`**:
  - уменьшить объём/количество документов в agent KB,
  - проверить лимиты:

```http
GET /v1/convai/agent/{agent_id}/knowledge-base/size
xi-api-key: {API_KEY}
```

- **`document_too_small`**:
  - объединить маленькие документы,
  - либо перевести критичные маленькие правила в `usage_mode: prompt`.

## 7) Включение cron на Render (безопасный rollout)

Рекомендуемая последовательность:

1) **Staging**:
   - ручной запуск 1–2 раза,
   - включить cron на staging,
   - понаблюдать 24–48 часов (логи, число обновлений, ошибки).

2) **Production**:
   - включить cron на production,
   - первые 1–2 запуска контролировать вручную (логи + проверка агента).

### 7.1 Команда cron

Ориентир:
```bash
python3 sync-with-monitoring.py --check --upload-to-elevenlabs
```

Важно: перед включением убедиться, что:
- генерация MD файлов работает,
- `sync_to_elevenlabs()` действительно вызывает `elevenlabs_sync_v2.py`,
- заданы env vars.

## 8) Наблюдаемость и логирование (что считать “успехом”)

Логи должны показывать:
- число документов у агента до/после,
- список обновлённых документов (по именам),
- результат `rag-index` (succeeded/failed/…),
- успешный `PATCH` агента,
- попытки удаления старых документов.

Рекомендация: хранить логи Render минимум 7–14 дней на период стабилизации.

## 9) Политика отката (rollback)

Минимальный rollback:
- временно выключить cron,
- восстановить у агента предыдущий `knowledge_base` (по сохранённому списку/логам),
- при необходимости удалить “лишние” документы из KB.

## 10) Точка готовности к продакшену (Definition of Done)

Считаем pipeline готовым, когда:
- staging работает стабильно 24–48 часов без критических ошибок,
- в production первый день нет ошибок `failed/rag_limit_exceeded` (или они обработаны),
- RAG-поиск на стороне агента реально возвращает актуальные данные,
- нет дублей документов в `knowledge_base` агента.


