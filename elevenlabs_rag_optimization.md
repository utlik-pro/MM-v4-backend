# ОПТИМИЗАЦИЯ RAG ДЛЯ БОЛЬШОГО ОБЪЕМА ДАННЫХ

## ПРОБЛЕМА
У нас 29 файлов с ~1MB данных о недвижимости. Агент должен ВСЕГДА давать точную информацию.

## РЕШЕНИЕ: МНОГОУРОВНЕВАЯ СТРУКТУРА RAG

### УРОВЕНЬ 1: ИНДЕКСНЫЙ ФАЙЛ (НАВИГАТОР)
**Файл:** `00-rag-navigation-index.md`
- Сверхкомпактный навигатор по всем квартирам
- Только ключевая информация: квартал → ценовой диапазон → файл
- Размер: максимум 2000 токенов
- Приоритет в RAG: НАИВЫСШИЙ

### УРОВЕНЬ 2: ЦЕНОВЫЕ КАТЕГОРИИ
**Файлы:** `01-budget-apartments.md`, `02-middle-apartments.md`, `03-premium-apartments.md`
- Предварительно отсортированные квартиры по ценам
- Быстрый доступ к нужной категории
- Размер каждого: 3000-4000 токенов
- Приоритет в RAG: ВЫСОКИЙ

### УРОВЕНЬ 3: ДЕТАЛЬНЫЕ ДАННЫЕ КВАРТАЛОВ
**Файлы:** Существующие файлы кварталов
- Полная информация о каждой квартире
- Приоритет в RAG: ОБЫЧНЫЙ

## НАСТРОЙКИ RAG В ELEVENLABS

### Оптимальные параметры для точности:

```json
{
  "chunk_size": 800,           // Меньше chunk = точнее поиск
  "chunk_overlap": 400,        // 50% overlap для контекста
  "retrieval_count": 7,        // Больше результатов для полноты
  "similarity_threshold": 0.8, // Высокий порог для точности
  "search_type": "hybrid",     // Комбинация keyword + semantic
  "reranking": true,           // Переранжирование результатов
  "temperature": 0.2           // Низкая для фактической точности
}
```

### Почему эти настройки:

1. **Chunk Size 800**: 
   - Каждая квартира помещается в один chunk
   - Нет потери контекста между chunks
   - Точное извлечение информации

2. **Overlap 400 (50%)**:
   - Гарантирует, что информация о квартире не разорвется
   - Сохраняет связность данных

3. **Retrieval Count 7**:
   - Достаточно для получения всех релевантных вариантов
   - Не перегружает контекст

4. **Similarity Threshold 0.8**:
   - Только высокорелевантные результаты
   - Исключает "похожие но неточные" данные

5. **Temperature 0.2**:
   - Минимальная креативность
   - Максимальная фактическая точность

## СТРУКТУРА ЗАПРОСОВ К RAG

### Алгоритм поиска информации:

```
1. ЗАПРОС → Определение категории бюджета
2. КАТЕГОРИЯ → Поиск в индексном файле
3. ИНДЕКС → Указание на нужные файлы кварталов  
4. ФАЙЛЫ → Извлечение конкретных квартир
5. КВАРТИРЫ → Формирование точного ответа
```

### Пример оптимизированного запроса:
Вместо: "найди дешевые квартиры"
Используем: "квартиры в категории budget 50000-70000 евро из файлов 7-Sredizemnomorskiy 21-Zapadnyy 30-Severnaya-Amerika"

## ВАЛИДАЦИЯ ДАННЫХ

### Проверочные правила в промпте:

```
ПЕРЕД КАЖДЫМ ОТВЕТОМ ПРОВЕРЬ:
1. Номер квартиры - должен быть числом
2. Цена - должна быть в евро с точным значением
3. Площадь - должна быть в м² с десятичными
4. Квартал - должен существовать в базе
5. Если хотя бы один параметр неясен - НЕ отвечай, запроси уточнение в базе
```

## ЭМПАТИЯ + ТОЧНОСТЬ

### Формула ответа:
```
ЭМОЦИЯ → ПРОВЕРКА ДАННЫХ → ТОЧНАЯ ИНФОРМАЦИЯ → ЭМОЦИОНАЛЬНОЕ ЗАКРЕПЛЕНИЕ

Пример:
"Понимаю, как важно найти доступное жилье!" [ЭМОЦИЯ]
→ [Проверка в базе: 7-Sredizemnomorskiy.md, квартира №234]
"У меня есть отличный вариант - квартира №234 в 7 квартале" [ТОЧНАЯ ИНФОРМАЦИЯ]  
"Уверена, вам понравится этот уютный район!" [ЭМОЦИОНАЛЬНОЕ ЗАКРЕПЛЕНИЕ]
```

## FALLBACK СТРАТЕГИЯ

Если агент не уверен в данных:

```
УРОВЕНЬ 1: "Давайте я уточню этот момент для вас"
↓
УРОВЕНЬ 2: Повторный поиск с расширенными параметрами
↓
УРОВЕНЬ 3: "Предлагаю рассмотреть похожие варианты, которые точно есть в наличии"
↓
УРОВЕНЬ 4: Переход к проверенным вариантам из индекса
```

## МЕТРИКИ КАЧЕСТВА

### Что отслеживать:
1. **Accuracy Rate**: % правильных цен и номеров квартир
2. **Hallucination Rate**: % придуманной информации (должен быть 0%)
3. **Response Relevance**: соответствие ответа запросу
4. **Empathy Score**: наличие эмоциональных элементов
5. **Conversion Rate**: % диалогов, завершенных записью на просмотр

### Целевые показатели:
- Accuracy Rate: >98%
- Hallucination Rate: 0%
- Response Relevance: >90%
- Empathy Score: >80%
- Conversion Rate: >30%

## ТЕСТОВЫЙ НАБОР ДЛЯ ПРОВЕРКИ

### Тест 1: Точность цен
"Сколько стоит самая дешевая квартира?"
✅ Ожидаемый ответ: назвать актуальный минимум из навигатора (обычно 21 квартал)

### Тест 2: Приоритизация
"Есть что-то до 70 тысяч?"
✅ Должен начать с 7 квартала, НЕ с дома София

### Тест 3: Эмпатия
"Это слишком дорого для меня"
✅ Должен проявить понимание И предложить рассрочку

### Тест 4: Несуществующий запрос  
"Есть квартиры за 10,000 евро?"
✅ Должен сказать, что минимальная цена берётся из навигатора (и предложить рассрочку/альтернативы)

### Тест 5: Детальная информация
"Расскажи про квартиру №234 в 7 квартале"
✅ Должен дать ВСЕ параметры: площадь, этаж, цену, статус